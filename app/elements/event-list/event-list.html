<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../event-card/event-card.html">

<dom-module id="event-list">

<style>
  :host {
    display: block;
  }
</style>

<template>
  <template
    is="dom-repeat"
    items="{{events}}"
    filter="{{_getFilter(showHiddenEvents, showHiddenCalendars)}}"
    observe="hidden calendarHidden">

    <event-card
      event-id="[[item.eventId]]"
      calendar-id="[[item.calendarId]]"
      recurrence-id="[[item.recurrenceId]]"
      name="[[item.name]]"
      start-date-ms="[[_getDateInMs(item.startDate)]]"
      end-date-ms="[[_getDateInMs(item.endDate)]]"
      first="[[!index]]"
      opened="[[_isOpened(index, openedIndex)]]"
      starred="{{item.starred}}"
      event-hidden="{{item.hidden}}"
      calendar-hidden="[[item.calendarHidden]]"
      color="[[item.color]]"
      link="[[item.link]]"
      on-event-open-toggled="_onEventOpenToggled">
    </event-card>
  </template>
</template>

<script>
(function () {
  'use strict';

  Polymer({
    is: 'event-list',

    properties: {
      events: {
        type: Array,
        notify: true,
      },

      // TODO: make openedIndex change when order changes
      openedIndex: {
        type: Number,
        value: 0,
      },
      showHiddenEvents: Boolean,
      showHiddenCalendars: Boolean,
    },

    /**
     * Open an event by id.
     *
     * @param {String} eventId - The event's id.
     */
    openEvent: function (calendarId, eventId) {
      var eventIndex = this._getEventIndex(calendarId, eventId);
      if (eventIndex !== -1) {
        this.openedIndex = eventIndex;
      }
    },

    _isOpened: function (eventIndex, openedIndex) {
      return eventIndex === openedIndex;
    },

    _getEventIndex: function (calendarId, eventId) {
      return this.events.findIndex(function (calendarEvent) {
        return calendarEvent.eventId === eventId &&
               calendarEvent.calendarId === calendarId;
      });
    },

    _getDateInMs: function (dateString) {
      return Date.parse(dateString);
    },

    _getFilter: function (showHiddenEvents, showHiddenCalendars) {
      if (!showHiddenEvents && !showHiddenCalendars) {
        return function (calendarEvent) {
          return !calendarEvent.hidden && !calendarEvent.calendarHidden;
        };
      } else if (!showHiddenEvents) {
        return function (calendarEvent) {
          return !calendarEvent.hidden;
        };
      } else if (!showHiddenCalendars) {
        return function (calendarEvent) {
          return !calendarEvent.calendarHidden;
        };
      } else {
        return null;
      }
    },

    _onEventOpenToggled: function (event) {
      if (event.detail.opened) {
        var old = this.$$('event-card[opened]');
        if (old) {
          old.toggleExpand();
        }

        this.openedIndex = event.model.index;
      } else {
        this.openedIndex = -1;
      }
    },
  });
})();
</script>

</dom-module>
